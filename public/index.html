<!DOCTYPE html>
<html>

<head>
  <title>ChatGPT Demo</title>
  <style>
    #chat-container {
      width: 600px;
      margin: 0 auto;
      padding: 20px;
      border: 1px solid #ccc;
    }

    .message {
      margin-bottom: 10px;
    }

    .user-message {
      background-color: #f2f2f2;
    }

    .bot-message {
      background-color: #e6f2ff;
    }

    input[type="text"] {
      width: 80%;
      padding: 12px 20px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 2px solid #ccc;
      border-radius: 4px;
    }

    input[type="submit"] {
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    pre {
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 10px;
      overflow-x: auto;
    }

    code {
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
</head>

<body>
  <div id="chat-container">
    <h1>ChatGPT Demo</h1>
    <div id="messages"></div>
    <form id="message-form">
      <label for="message-input">Enter your message:</label>
      <br>
      <input type="text" id="message-input" name="message" autocomplete="off">
      <input type="submit" value="Send">
    </form>
  </div>

  <script>
    let promptImpersonate = "<|im_start|>system\nYou are an AI assistant that helps people find information.\n<|im_end|>\n";
    let prompts = [];
    // add the promptImpersonate to the prompts array last so that it is the last prompt
    prompts.push(promptImpersonate);

    const messagesContainer = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    async function sendMessage(message) {
      addMessage('user', message);
      let userPrompt = "<|im_start|>user\n" + message + "\n<|im_end|>\n";
      prompts.push(userPrompt);
      const promptText = prompts.join('');
      console.log(promptText);

      messageInput.value = '';
      const response = await fetch('/api/gpt', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prompt: promptText })
      });

      if (!response.ok) {
        addMessage('bot', 'Error generating response.');
        return;
      }

      const data = await response.text();
      console.log(data);
      // 添加回复到prompt
      prompts.push("<|im_start|>assistant\n" + data + "\n<|im_end|>\n");

      addMessage('bot', data);
    }

    function addMessage(sender, message) {

      const messageElement = document.createElement('div');
      messageElement.classList.add('message');
      messageElement.classList.add(`${sender}-message`);
      if (message.includes('```')) {
        const codeBlocks = message.match(/```(\w+)?\n([\s\S]+?)\n```/g);
        if (codeBlocks) {
          codeBlocks.forEach((block) => {
            const code = block.replace(/```(\w+)?\n([\s\S]+?)\n```/, '$2');
            const pre = document.createElement('pre');
            const codeElement = document.createElement('code');
            codeElement.innerText = code;
            pre.appendChild(codeElement);
            message = message.replace(block, pre.outerHTML);
          });
        }
        messageElement.innerHTML = message;
      } else {
        messageElement.innerText = message;
      }

      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    messageForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const message = messageInput.value.trim();
      if (message) {
        sendMessage(message);
      }
    });

    messageInput.focus();
  </script>
</body>

</html>